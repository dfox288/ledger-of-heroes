# Database Cleanup Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Clean up database schema inconsistencies and add creature type normalization.

**Architecture:** Three independent issues that can be implemented in sequence. #505 (cleanup) first as warmup, then #503 (creature_types), then #502 (monster_traits migration).

**Tech Stack:** Laravel 12.x, MySQL/SQLite, Pest 3.x

**Related Issues:**
- [#502 - Migrate monster_traits to polymorphic entity_traits](https://github.com/dfox288/ledger-of-heroes/issues/502)
- [#503 - Normalize creature types into lookup table](https://github.com/dfox288/ledger-of-heroes/issues/503)
- [#505 - Minor database cleanup](https://github.com/dfox288/ledger-of-heroes/issues/505)

**IMPORTANT:** Creature type slugs must be prefixed with `core:` for consistency with other lookup tables (e.g., `core:undead`, `core:humanoid`). Update CreatureTypeSeeder and MonsterImporter accordingly.

**Reference:** `wrapper/docs/backend/proposals/2025-12-11-database-architecture-audit.md`

---

## Phase 1: Minor Cleanup (#505)

### Task 1.1: Fix EntityLanguage Relationship Naming

**Problem:** `EntityLanguage.php` uses `entity()` method while all other polymorphic models use `reference()`.

**Files:**
- Modify: `app/Models/EntityLanguage.php:31-34`
- Test: `tests/Unit/Models/EntityLanguageTest.php` (create if needed)

**Step 1: Check for usages of entity() method**

```bash
docker compose exec php grep -r "->entity(" app/ --include="*.php" | grep -v ".blade.php"
```

Expected: Few or no usages (method likely unused in production code)

**Step 2: Write test for reference() method**

Create `tests/Unit/Models/EntityLanguageTest.php`:

```php
<?php

use App\Models\EntityLanguage;
use App\Models\Race;

it('has reference relationship to parent entity', function () {
    $race = Race::factory()->create();
    $entityLanguage = EntityLanguage::factory()->create([
        'reference_type' => Race::class,
        'reference_id' => $race->id,
    ]);

    expect($entityLanguage->reference)->toBeInstanceOf(Race::class);
    expect($entityLanguage->reference->id)->toBe($race->id);
});
```

**Step 3: Run test to verify it fails**

```bash
docker compose exec php ./vendor/bin/pest tests/Unit/Models/EntityLanguageTest.php -v
```

Expected: FAIL - `reference` method doesn't exist

**Step 4: Update EntityLanguage model**

Change `app/Models/EntityLanguage.php`:

```php
// Change from:
public function entity(): MorphTo
{
    return $this->morphTo(null, 'reference_type', 'reference_id');
}

// To:
public function reference(): MorphTo
{
    return $this->morphTo(null, 'reference_type', 'reference_id');
}
```

**Step 5: Run test to verify it passes**

```bash
docker compose exec php ./vendor/bin/pest tests/Unit/Models/EntityLanguageTest.php -v
```

Expected: PASS

**Step 6: Update any entity() usages found in Step 1**

If any usages found, update them to use `reference()`.

**Step 7: Run full Unit-DB suite**

```bash
docker compose exec php ./vendor/bin/pest --testsuite=Unit-DB
```

Expected: All tests pass

**Step 8: Commit**

```bash
git add app/Models/EntityLanguage.php tests/Unit/Models/EntityLanguageTest.php
git commit -m "refactor(#505): rename EntityLanguage::entity() to reference() for consistency"
```

---

### Task 1.2: Remove Dead Listener Code

**Problem:** `PopulateCharacterAbilities` listener references `race_id` and `background_id` but Character uses `race_slug` and `background_slug`.

**Files:**
- Analyze: `app/Listeners/PopulateCharacterAbilities.php`
- Analyze: `app/Models/Character.php`
- Modify: `app/Providers/AppServiceProvider.php` (if listener is registered)

**Step 1: Verify Character model uses slugs not IDs**

```bash
docker compose exec php php artisan tinker --execute="
\$char = \App\Models\Character::first();
echo 'Has race_slug: ' . (isset(\$char->race_slug) ? 'yes' : 'no') . PHP_EOL;
echo 'Has race_id: ' . (property_exists(\$char, 'race_id') ? 'yes' : 'no') . PHP_EOL;
"
```

Expected: Has race_slug: yes, Has race_id: no

**Step 2: Check if listener is registered**

```bash
docker compose exec php grep -r "PopulateCharacterAbilities" app/Providers/
```

**Step 3: Check if listener is used anywhere**

```bash
docker compose exec php grep -r "CharacterUpdated" app/ --include="*.php"
```

**Step 4: Document findings**

If listener is dead code:
- Add deprecation comment OR
- Remove listener and event if completely unused

If listener is active but broken:
- Fix to use `race_slug` and `background_slug`

**Step 5: Remove or fix based on findings**

Option A - If completely unused, remove:
```bash
rm app/Listeners/PopulateCharacterAbilities.php
rm app/Events/CharacterUpdated.php  # if exists and unused
rm tests/Unit/Listeners/PopulateCharacterAbilitiesTest.php
```

Option B - If used but broken, fix the listener to work with slugs.

**Step 6: Run test suite**

```bash
docker compose exec php ./vendor/bin/pest --testsuite=Unit-DB
```

**Step 7: Commit**

```bash
git add -A
git commit -m "chore(#505): remove dead PopulateCharacterAbilities listener"
```

---

## Phase 2: Creature Types Normalization (#503)

### Task 2.1: Create creature_types Migration

**Files:**
- Create: `database/migrations/2025_12_12_000001_create_creature_types_table.php`

**Step 1: Generate migration**

```bash
docker compose exec php php artisan make:migration create_creature_types_table
```

**Step 2: Write migration**

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('creature_types', function (Blueprint $table) {
            $table->id();
            $table->string('slug', 50)->unique();
            $table->string('name', 50);
            $table->boolean('typically_immune_to_poison')->default(false);
            $table->boolean('typically_immune_to_charmed')->default(false);
            $table->boolean('typically_immune_to_frightened')->default(false);
            $table->boolean('typically_immune_to_exhaustion')->default(false);
            $table->boolean('requires_sustenance')->default(true);
            $table->boolean('requires_sleep')->default(true);
            $table->text('description')->nullable();
        });

        // Add FK to monsters (nullable for migration safety)
        Schema::table('monsters', function (Blueprint $table) {
            $table->foreignId('creature_type_id')
                ->nullable()
                ->after('type')
                ->constrained('creature_types')
                ->nullOnDelete();
        });
    }

    public function down(): void
    {
        Schema::table('monsters', function (Blueprint $table) {
            $table->dropForeign(['creature_type_id']);
            $table->dropColumn('creature_type_id');
        });

        Schema::dropIfExists('creature_types');
    }
};
```

**Step 3: Run migration**

```bash
docker compose exec php php artisan migrate
```

Expected: Migration successful

**Step 4: Commit**

```bash
git add database/migrations/*create_creature_types*
git commit -m "feat(#503): add creature_types migration"
```

---

### Task 2.2: Create CreatureType Model and Factory

**Files:**
- Create: `app/Models/CreatureType.php`
- Create: `database/factories/CreatureTypeFactory.php`

**Step 1: Create model**

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Relations\HasMany;

class CreatureType extends BaseModel
{
    public $timestamps = false;

    protected $fillable = [
        'slug',
        'name',
        'typically_immune_to_poison',
        'typically_immune_to_charmed',
        'typically_immune_to_frightened',
        'typically_immune_to_exhaustion',
        'requires_sustenance',
        'requires_sleep',
        'description',
    ];

    protected $casts = [
        'typically_immune_to_poison' => 'boolean',
        'typically_immune_to_charmed' => 'boolean',
        'typically_immune_to_frightened' => 'boolean',
        'typically_immune_to_exhaustion' => 'boolean',
        'requires_sustenance' => 'boolean',
        'requires_sleep' => 'boolean',
    ];

    public function monsters(): HasMany
    {
        return $this->hasMany(Monster::class);
    }
}
```

**Step 2: Create factory**

```php
<?php

namespace Database\Factories;

use App\Models\CreatureType;
use Illuminate\Database\Eloquent\Factories\Factory;

class CreatureTypeFactory extends Factory
{
    protected $model = CreatureType::class;

    public function definition(): array
    {
        return [
            'slug' => $this->faker->unique()->slug(2),
            'name' => $this->faker->word(),
            'typically_immune_to_poison' => false,
            'typically_immune_to_charmed' => false,
            'typically_immune_to_frightened' => false,
            'typically_immune_to_exhaustion' => false,
            'requires_sustenance' => true,
            'requires_sleep' => true,
            'description' => $this->faker->sentence(),
        ];
    }

    public function undead(): static
    {
        return $this->state([
            'slug' => 'undead',
            'name' => 'Undead',
            'typically_immune_to_poison' => true,
            'typically_immune_to_charmed' => true,
            'typically_immune_to_exhaustion' => true,
            'requires_sustenance' => false,
            'requires_sleep' => false,
        ]);
    }

    public function construct(): static
    {
        return $this->state([
            'slug' => 'construct',
            'name' => 'Construct',
            'typically_immune_to_poison' => true,
            'typically_immune_to_charmed' => true,
            'typically_immune_to_frightened' => true,
            'typically_immune_to_exhaustion' => true,
            'requires_sustenance' => false,
            'requires_sleep' => false,
        ]);
    }
}
```

**Step 3: Commit**

```bash
git add app/Models/CreatureType.php database/factories/CreatureTypeFactory.php
git commit -m "feat(#503): add CreatureType model and factory"
```

---

### Task 2.3: Create Seeder for D&D 5e Creature Types

**Files:**
- Create: `database/seeders/CreatureTypeSeeder.php`

**Step 1: Create seeder**

```php
<?php

namespace Database\Seeders;

use App\Models\CreatureType;
use Illuminate\Database\Seeder;

class CreatureTypeSeeder extends Seeder
{
    public function run(): void
    {
        $types = [
            [
                'slug' => 'aberration',
                'name' => 'Aberration',
                'description' => 'Utterly alien beings with bizarre anatomy, strange abilities, or alien mindsets.',
            ],
            [
                'slug' => 'beast',
                'name' => 'Beast',
                'description' => 'Nonhumanoid creatures that are part of the natural world.',
            ],
            [
                'slug' => 'celestial',
                'name' => 'Celestial',
                'description' => 'Creatures native to the Upper Planes, often agents of good.',
            ],
            [
                'slug' => 'construct',
                'name' => 'Construct',
                'typically_immune_to_poison' => true,
                'typically_immune_to_charmed' => true,
                'typically_immune_to_frightened' => true,
                'typically_immune_to_exhaustion' => true,
                'requires_sustenance' => false,
                'requires_sleep' => false,
                'description' => 'Made, not born. Animated by magic.',
            ],
            [
                'slug' => 'dragon',
                'name' => 'Dragon',
                'description' => 'Large reptilian creatures of ancient origin and tremendous power.',
            ],
            [
                'slug' => 'elemental',
                'name' => 'Elemental',
                'typically_immune_to_poison' => true,
                'typically_immune_to_exhaustion' => true,
                'requires_sustenance' => false,
                'requires_sleep' => false,
                'description' => 'Creatures native to the elemental planes.',
            ],
            [
                'slug' => 'fey',
                'name' => 'Fey',
                'description' => 'Magical creatures closely tied to the forces of nature.',
            ],
            [
                'slug' => 'fiend',
                'name' => 'Fiend',
                'typically_immune_to_poison' => true,
                'description' => 'Wicked creatures native to the Lower Planes.',
            ],
            [
                'slug' => 'giant',
                'name' => 'Giant',
                'description' => 'Humanlike creatures of great stature and strength.',
            ],
            [
                'slug' => 'humanoid',
                'name' => 'Humanoid',
                'description' => 'The main peoples of the world, including humans and their kin.',
            ],
            [
                'slug' => 'monstrosity',
                'name' => 'Monstrosity',
                'description' => 'Frightening creatures not ordinary, not truly natural, and not of divine origin.',
            ],
            [
                'slug' => 'ooze',
                'name' => 'Ooze',
                'typically_immune_to_poison' => true,
                'typically_immune_to_charmed' => true,
                'typically_immune_to_frightened' => true,
                'typically_immune_to_exhaustion' => true,
                'requires_sustenance' => false,
                'requires_sleep' => false,
                'description' => 'Gelatinous creatures that rarely have a fixed shape.',
            ],
            [
                'slug' => 'plant',
                'name' => 'Plant',
                'description' => 'Vegetable creatures, not ordinary flora.',
            ],
            [
                'slug' => 'undead',
                'name' => 'Undead',
                'typically_immune_to_poison' => true,
                'typically_immune_to_charmed' => true,
                'typically_immune_to_exhaustion' => true,
                'requires_sustenance' => false,
                'requires_sleep' => false,
                'description' => 'Once-living creatures brought to unlife through necromancy or curse.',
            ],
            [
                'slug' => 'swarm',
                'name' => 'Swarm',
                'description' => 'A mass of creatures acting as a single entity.',
            ],
        ];

        foreach ($types as $type) {
            CreatureType::updateOrCreate(
                ['slug' => $type['slug']],
                array_merge([
                    'typically_immune_to_poison' => false,
                    'typically_immune_to_charmed' => false,
                    'typically_immune_to_frightened' => false,
                    'typically_immune_to_exhaustion' => false,
                    'requires_sustenance' => true,
                    'requires_sleep' => true,
                ], $type)
            );
        }
    }
}
```

**Step 2: Run seeder**

```bash
docker compose exec php php artisan db:seed --class=CreatureTypeSeeder
```

**Step 3: Verify seeder**

```bash
docker compose exec php php artisan tinker --execute="echo \App\Models\CreatureType::count();"
```

Expected: 15

**Step 4: Commit**

```bash
git add database/seeders/CreatureTypeSeeder.php
git commit -m "feat(#503): add CreatureTypeSeeder with D&D 5e creature types"
```

---

### Task 2.4: Update Monster Model

**Files:**
- Modify: `app/Models/Monster.php`
- Test: `tests/Unit/Models/MonsterCreatureTypeTest.php`

**Step 1: Write test**

```php
<?php

use App\Models\CreatureType;
use App\Models\Monster;

it('belongs to a creature type', function () {
    $creatureType = CreatureType::factory()->undead()->create();
    $monster = Monster::factory()->create(['creature_type_id' => $creatureType->id]);

    expect($monster->creatureType)->toBeInstanceOf(CreatureType::class);
    expect($monster->creatureType->slug)->toBe('undead');
});

it('can filter monsters by creature type', function () {
    $undead = CreatureType::factory()->undead()->create();
    $construct = CreatureType::factory()->construct()->create();

    Monster::factory()->count(3)->create(['creature_type_id' => $undead->id]);
    Monster::factory()->count(2)->create(['creature_type_id' => $construct->id]);

    expect(Monster::where('creature_type_id', $undead->id)->count())->toBe(3);
    expect(Monster::where('creature_type_id', $construct->id)->count())->toBe(2);
});
```

**Step 2: Run test to verify it fails**

```bash
docker compose exec php ./vendor/bin/pest tests/Unit/Models/MonsterCreatureTypeTest.php -v
```

Expected: FAIL - creatureType relationship doesn't exist

**Step 3: Add relationship to Monster model**

Add to `app/Models/Monster.php`:

```php
use Illuminate\Database\Eloquent\Relations\BelongsTo;

// In fillable array, add:
'creature_type_id',

// Add relationship method:
public function creatureType(): BelongsTo
{
    return $this->belongsTo(CreatureType::class);
}
```

**Step 4: Run test to verify it passes**

```bash
docker compose exec php ./vendor/bin/pest tests/Unit/Models/MonsterCreatureTypeTest.php -v
```

Expected: PASS

**Step 5: Commit**

```bash
git add app/Models/Monster.php tests/Unit/Models/MonsterCreatureTypeTest.php
git commit -m "feat(#503): add creatureType relationship to Monster model"
```

---

### Task 2.5: Update MonsterImporter to Set creature_type_id

**Problem:** MonsterImporter needs to link monsters to their creature_type during import based on the type string.

**Files:**
- Modify: `app/Services/Importers/MonsterImporter.php`
- Test: `tests/Feature/Importers/MonsterImporterTest.php`

**Step 1: Write test for creature_type linking**

Add to `tests/Feature/Importers/MonsterImporterTest.php`:

```php
it('links monster to creature_type based on type string', function () {
    // Ensure creature types are seeded
    $this->seed(CreatureTypeSeeder::class);

    $importer = app(MonsterImporter::class);
    $importer->import();

    // Check a humanoid monster
    $humanoid = Monster::where('type', 'like', 'humanoid%')->first();
    expect($humanoid->creature_type_id)->not->toBeNull();
    expect($humanoid->creatureType->slug)->toBe('humanoid');

    // Check an undead monster
    $undead = Monster::where('type', 'undead')->first();
    if ($undead) {
        expect($undead->creatureType->slug)->toBe('undead');
    }
});
```

**Step 2: Run test to verify it fails**

```bash
docker compose exec php ./vendor/bin/pest tests/Feature/Importers/MonsterImporterTest.php --filter="links monster to creature_type"
```

Expected: FAIL - creature_type_id is null

**Step 3: Update MonsterImporter**

Add helper method and update import logic in `app/Services/Importers/MonsterImporter.php`:

```php
use App\Models\CreatureType;

// Add property to cache creature types
protected array $creatureTypeCache = [];

// Add method to resolve creature type
protected function resolveCreatureTypeId(string $type): ?int
{
    // Lazy load cache
    if (empty($this->creatureTypeCache)) {
        $this->creatureTypeCache = CreatureType::pluck('id', 'slug')->all();
    }

    $baseType = $this->extractBaseCreatureType($type);
    $slug = strtolower($baseType);

    return $this->creatureTypeCache[$slug] ?? null;
}

/**
 * Extract base creature type from type string.
 * "humanoid (elf)" -> "humanoid"
 * "fiend (demon, shapechanger)" -> "fiend"
 * "swarm of tiny beasts" -> "swarm"
 */
protected function extractBaseCreatureType(string $type): string
{
    // Handle swarms first
    if (str_starts_with(strtolower($type), 'swarm')) {
        return 'swarm';
    }

    // Extract base type before parentheses
    if (str_contains($type, '(')) {
        return trim(explode('(', $type)[0]);
    }

    return $type;
}

// In createOrUpdateMonster(), add creature_type_id:
'creature_type_id' => $this->resolveCreatureTypeId($monsterData['type']),
```

**Step 4: Run test to verify it passes**

```bash
docker compose exec php ./vendor/bin/pest tests/Feature/Importers/MonsterImporterTest.php --filter="links monster to creature_type"
```

Expected: PASS

**Step 5: Run full importer test suite**

```bash
docker compose exec php ./vendor/bin/pest --testsuite=Importers
```

**Step 6: Commit**

```bash
git add app/Services/Importers/MonsterImporter.php tests/Feature/Importers/MonsterImporterTest.php
git commit -m "feat(#503): update MonsterImporter to set creature_type_id"
```

---

### Task 2.6: Update Monster toSearchableArray

**Files:**
- Modify: `app/Models/Monster.php`

**Step 1: Update toSearchableArray to include creature_type_slug**

In `Monster.php` `toSearchableArray()` method, add:

```php
// In loadMissing, add creatureType:
$this->loadMissing(['size', 'sources.source', 'spells', 'tags', 'legendaryActions', 'actions', 'traits', 'senses.sense', 'creatureType']);

// In return array, add:
'creature_type_slug' => $this->creatureType?->slug,
'creature_type_name' => $this->creatureType?->name,
```

**Step 2: Update searchableOptions**

In `filterableAttributes`, add:
```php
'creature_type_slug',
```

**Step 3: Re-sync index settings**

```bash
docker compose exec php php artisan scout:sync-index-settings
```

**Step 4: Re-index monsters**

```bash
docker compose exec php php artisan scout:import "App\Models\Monster"
```

**Step 5: Run Unit-DB tests**

```bash
docker compose exec php ./vendor/bin/pest --testsuite=Unit-DB
```

**Step 6: Commit**

```bash
git add app/Models/Monster.php
git commit -m "feat(#503): add creature_type to Monster search index"
```

---

### Task 2.7: Create CreatureType API Endpoint

**Files:**
- Create: `app/Http/Controllers/Api/Lookups/CreatureTypeController.php`
- Create: `app/Http/Resources/CreatureTypeResource.php`
- Modify: `routes/api.php`

**Step 1: Create Resource**

```php
<?php

namespace App\Http\Resources;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class CreatureTypeResource extends JsonResource
{
    public function toArray(Request $request): array
    {
        return [
            'id' => $this->id,
            'slug' => $this->slug,
            'name' => $this->name,
            'typically_immune_to_poison' => $this->typically_immune_to_poison,
            'typically_immune_to_charmed' => $this->typically_immune_to_charmed,
            'typically_immune_to_frightened' => $this->typically_immune_to_frightened,
            'typically_immune_to_exhaustion' => $this->typically_immune_to_exhaustion,
            'requires_sustenance' => $this->requires_sustenance,
            'requires_sleep' => $this->requires_sleep,
            'description' => $this->description,
        ];
    }
}
```

**Step 2: Create Controller**

```php
<?php

namespace App\Http\Controllers\Api\Lookups;

use App\Http\Controllers\Controller;
use App\Http\Resources\CreatureTypeResource;
use App\Models\CreatureType;
use Illuminate\Http\Resources\Json\AnonymousResourceCollection;

class CreatureTypeController extends Controller
{
    public function index(): AnonymousResourceCollection
    {
        return CreatureTypeResource::collection(
            CreatureType::orderBy('name')->get()
        );
    }
}
```

**Step 3: Add route**

In `routes/api.php`, add to lookups group:

```php
Route::get('creature-types', [Lookups\CreatureTypeController::class, 'index']);
```

**Step 4: Test endpoint**

```bash
curl -s http://localhost:8080/api/v1/lookups/creature-types | jq '.data | length'
```

Expected: 15

**Step 5: Commit**

```bash
git add app/Http/Controllers/Api/Lookups/CreatureTypeController.php app/Http/Resources/CreatureTypeResource.php routes/api.php
git commit -m "feat(#503): add creature-types lookup endpoint"
```

---

## Phase 3: Monster Traits Migration (#502)

### Task 3.1: Add attack_data Column to entity_traits

**Files:**
- Create: Migration to add attack_data column

**Step 1: Create migration**

```bash
docker compose exec php php artisan make:migration add_attack_data_to_entity_traits
```

**Step 2: Write migration**

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::table('entity_traits', function (Blueprint $table) {
            $table->text('attack_data')->nullable()->after('description');
        });
    }

    public function down(): void
    {
        Schema::table('entity_traits', function (Blueprint $table) {
            $table->dropColumn('attack_data');
        });
    }
};
```

**Step 3: Run migration**

```bash
docker compose exec php php artisan migrate
```

**Step 4: Commit**

```bash
git add database/migrations/*add_attack_data_to_entity_traits*
git commit -m "feat(#502): add attack_data column to entity_traits"
```

---

### Task 3.2: Update MonsterImporter to Write to entity_traits

**Problem:** MonsterImporter currently writes traits to `monster_traits` table via `MonsterTrait` model. Need to write to `entity_traits` via `CharacterTrait` model instead.

**Files:**
- Modify: `app/Services/Importers/MonsterImporter.php`
- Test: `tests/Feature/Importers/MonsterImporterTest.php`

**Step 1: Write test for polymorphic traits**

Add to `tests/Feature/Importers/MonsterImporterTest.php`:

```php
it('imports monster traits to entity_traits table', function () {
    // Import a monster with known traits
    $importer = app(MonsterImporter::class);
    $importer->import();

    $monster = Monster::where('slug', 'like', '%aboleth%')->first();

    // Traits should be in entity_traits, not monster_traits
    expect($monster->entityTraits)->not->toBeEmpty();
    expect($monster->entityTraits->first())->toBeInstanceOf(CharacterTrait::class);

    // Verify attack_data is preserved for traits that have it
    $traitWithAttack = $monster->entityTraits->first(fn ($t) => $t->attack_data !== null);
    if ($traitWithAttack) {
        expect($traitWithAttack->attack_data)->toBeString();
    }
});
```

**Step 2: Run test to verify it fails**

```bash
docker compose exec php ./vendor/bin/pest tests/Feature/Importers/MonsterImporterTest.php --filter="imports monster traits to entity_traits"
```

Expected: FAIL - entityTraits relationship doesn't exist yet or returns empty

**Step 3: Update MonsterImporter**

In `app/Services/Importers/MonsterImporter.php`:

```php
// Change import:
use App\Models\MonsterTrait;
// To:
use App\Models\CharacterTrait;

// Update importMonsterTraits method:
/**
 * Import monster traits to polymorphic entity_traits table.
 */
protected function importMonsterTraits(Monster $monster, array $traits): void
{
    // Clear existing traits from entity_traits
    CharacterTrait::where('reference_type', Monster::class)
        ->where('reference_id', $monster->id)
        ->delete();

    foreach ($traits as $trait) {
        CharacterTrait::create([
            'reference_type' => Monster::class,
            'reference_id' => $monster->id,
            'name' => $trait['name'],
            'description' => $trait['description'],
            'attack_data' => $trait['attack_data'],
            'sort_order' => $trait['sort_order'],
        ]);
    }
}
```

**Step 4: Run test to verify it passes**

```bash
docker compose exec php ./vendor/bin/pest tests/Feature/Importers/MonsterImporterTest.php --filter="imports monster traits to entity_traits"
```

Expected: PASS

**Step 5: Run full importer test suite**

```bash
docker compose exec php ./vendor/bin/pest --testsuite=Importers
```

**Step 6: Commit**

```bash
git add app/Services/Importers/MonsterImporter.php tests/Feature/Importers/MonsterImporterTest.php
git commit -m "feat(#502): update MonsterImporter to write traits to entity_traits"
```

---

### Task 3.3: Update Monster Model to Use HasEntityTraits

**Files:**
- Create: `app/Models/Concerns/HasEntityTraits.php` (if not exists)
- Modify: `app/Models/Monster.php`
- Test: `tests/Unit/Models/MonsterTraitsPolymorphicTest.php`

**Step 1: Check if HasEntityTraits concern exists**

```bash
ls app/Models/Concerns/HasEntityTraits.php 2>/dev/null || echo "Needs creation"
```

**Step 2: Create or verify HasEntityTraits trait**

If doesn't exist, create `app/Models/Concerns/HasEntityTraits.php`:

```php
<?php

namespace App\Models\Concerns;

use App\Models\CharacterTrait;
use Illuminate\Database\Eloquent\Relations\MorphMany;

trait HasEntityTraits
{
    public function entityTraits(): MorphMany
    {
        return $this->morphMany(CharacterTrait::class, 'reference')
            ->orderBy('sort_order');
    }
}
```

**Step 3: Write test**

```php
<?php

use App\Models\CharacterTrait;
use App\Models\Monster;

it('has polymorphic entity traits', function () {
    $monster = Monster::factory()->create();

    CharacterTrait::create([
        'reference_type' => Monster::class,
        'reference_id' => $monster->id,
        'name' => 'Magic Resistance',
        'description' => 'The monster has advantage on saving throws against spells.',
        'sort_order' => 1,
    ]);

    expect($monster->entityTraits)->toHaveCount(1);
    expect($monster->entityTraits->first()->name)->toBe('Magic Resistance');
});

it('orders traits by sort_order', function () {
    $monster = Monster::factory()->create();

    CharacterTrait::create([
        'reference_type' => Monster::class,
        'reference_id' => $monster->id,
        'name' => 'Second Trait',
        'description' => 'Description',
        'sort_order' => 2,
    ]);

    CharacterTrait::create([
        'reference_type' => Monster::class,
        'reference_id' => $monster->id,
        'name' => 'First Trait',
        'description' => 'Description',
        'sort_order' => 1,
    ]);

    $traits = $monster->fresh()->entityTraits;
    expect($traits->first()->name)->toBe('First Trait');
    expect($traits->last()->name)->toBe('Second Trait');
});
```

**Step 4: Run test to verify it fails**

```bash
docker compose exec php ./vendor/bin/pest tests/Unit/Models/MonsterTraitsPolymorphicTest.php -v
```

Expected: FAIL - entityTraits method doesn't exist

**Step 5: Update Monster model**

In `app/Models/Monster.php`:

```php
// Add use statement:
use App\Models\Concerns\HasEntityTraits;

// Add to traits list:
use HasEntityTraits;

// Keep existing traits() method for backward compatibility during transition:
// (Will be removed in Task 3.5)
```

**Step 6: Run test to verify it passes**

```bash
docker compose exec php ./vendor/bin/pest tests/Unit/Models/MonsterTraitsPolymorphicTest.php -v
```

Expected: PASS

**Step 7: Commit**

```bash
git add app/Models/Concerns/HasEntityTraits.php app/Models/Monster.php tests/Unit/Models/MonsterTraitsPolymorphicTest.php
git commit -m "feat(#502): add HasEntityTraits to Monster model"
```

---

### Task 3.4: Update MonsterResource to Use entityTraits

**Files:**
- Modify: `app/Http/Resources/MonsterResource.php`
- Test existing monster API tests

**Step 1: Find MonsterResource**

```bash
cat app/Http/Resources/MonsterResource.php | grep -A5 "traits"
```

**Step 2: Update MonsterResource**

Change `traits` in the resource to use `entityTraits`:

```php
// Change from:
'traits' => MonsterTraitResource::collection($this->traits),

// To:
'traits' => MonsterTraitResource::collection($this->entityTraits),
```

**Step 3: Update Monster eager loading**

In MonsterController, update eager loading:

```php
// Change 'traits' to 'entityTraits' in any with() or load() calls
```

**Step 4: Run Feature-DB tests**

```bash
docker compose exec php ./vendor/bin/pest --testsuite=Feature-DB --filter=Monster
```

**Step 5: Commit**

```bash
git add app/Http/Resources/MonsterResource.php app/Http/Controllers/Api/MonsterController.php
git commit -m "feat(#502): update MonsterResource to use entityTraits"
```

---

### Task 3.5: Update toSearchableArray and Remove Old traits()

**Files:**
- Modify: `app/Models/Monster.php`

**Step 1: Update toSearchableArray**

In `Monster.php`, update `loadMissing`:

```php
// Change 'traits' to 'entityTraits':
$this->loadMissing(['size', 'sources.source', 'spells', 'tags', 'legendaryActions', 'actions', 'entityTraits', 'senses.sense', 'creatureType']);
```

And update trait references:

```php
// Change:
'has_legendary_resistance' => $this->traits->contains(fn ($t) => str_contains($t->name, 'Legendary Resistance')),
'has_magic_resistance' => $this->traits->contains('name', 'Magic Resistance'),

// To:
'has_legendary_resistance' => $this->entityTraits->contains(fn ($t) => str_contains($t->name, 'Legendary Resistance')),
'has_magic_resistance' => $this->entityTraits->contains('name', 'Magic Resistance'),
```

**Step 2: Remove old traits() relationship**

Delete the old `traits()` method that returned `HasMany`:

```php
// Remove this method:
public function traits(): HasMany
{
    return $this->hasMany(MonsterTrait::class);
}
```

**Step 3: Run all tests**

```bash
docker compose exec php ./vendor/bin/pest --testsuite=Unit-DB
docker compose exec php ./vendor/bin/pest --testsuite=Feature-DB --filter=Monster
```

**Step 4: Commit**

```bash
git add app/Models/Monster.php
git commit -m "feat(#502): update Monster to use entityTraits exclusively"
```

---

### Task 3.6: Drop monster_traits Table

**Files:**
- Create: Migration to drop table
- Delete: `app/Models/MonsterTrait.php`

**Step 1: Create migration**

```bash
docker compose exec php php artisan make:migration drop_monster_traits_table
```

**Step 2: Write migration**

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::dropIfExists('monster_traits');
    }

    public function down(): void
    {
        Schema::create('monster_traits', function (Blueprint $table) {
            $table->id();
            $table->foreignId('monster_id')->constrained()->cascadeOnDelete();
            $table->string('name', 255);
            $table->text('description');
            $table->text('attack_data')->nullable();
            $table->smallInteger('sort_order')->unsigned()->default(0);
        });
    }
};
```

**Step 3: Run migration**

```bash
docker compose exec php php artisan migrate
```

**Step 4: Delete MonsterTrait model**

```bash
rm app/Models/MonsterTrait.php
```

**Step 5: Remove any remaining MonsterTrait references**

```bash
docker compose exec php grep -r "MonsterTrait" app/ --include="*.php"
```

Update any files still referencing MonsterTrait.

**Step 6: Run all tests**

```bash
docker compose exec php ./vendor/bin/pest --testsuite=Unit-DB
docker compose exec php ./vendor/bin/pest --testsuite=Feature-DB
```

**Step 7: Commit**

```bash
git add -A
git commit -m "feat(#502): drop monster_traits table and model"
```

---

## Phase 4: Final Quality Gates

### Task 4.1: Run All Test Suites

```bash
docker compose exec php ./vendor/bin/pest --testsuite=Unit-Pure
docker compose exec php ./vendor/bin/pest --testsuite=Unit-DB
docker compose exec php ./vendor/bin/pest --testsuite=Feature-DB
```

### Task 4.2: Run Pint

```bash
docker compose exec php ./vendor/bin/pint
```

### Task 4.3: Fresh Import Verification

```bash
docker compose exec php php artisan migrate:fresh --seed
docker compose exec php php artisan import:all
```

Verify counts:
```bash
docker compose exec php php artisan tinker --execute="
echo 'Monsters: ' . \App\Models\Monster::count() . PHP_EOL;
echo 'Creature Types: ' . \App\Models\CreatureType::count() . PHP_EOL;
echo 'Monster entity_traits: ' . DB::table('entity_traits')->where('reference_type', \App\Models\Monster::class)->count() . PHP_EOL;
"
```

### Task 4.4: Update CHANGELOG.md

Add under `[Unreleased]`:

```markdown
### Changed

- **Issue #502**: Migrated `monster_traits` to polymorphic `entity_traits` table
  - Monster now uses `HasEntityTraits` trait
  - `attack_data` column added to `entity_traits`
  - Dropped `monster_traits` table
  - Enables unified cross-entity trait queries

- **Issue #503**: Normalized creature types into lookup table
  - New `creature_types` table with 15 D&D 5e creature types
  - Tracks typical immunities and sustenance requirements per type
  - Monsters linked via `creature_type_id` FK
  - New `/api/v1/lookups/creature-types` endpoint
  - `creature_type_slug` now filterable in Meilisearch

### Fixed

- **Issue #505**: Minor cleanup
  - Renamed `EntityLanguage::entity()` to `reference()` for polymorphic consistency
  - Removed dead `PopulateCharacterAbilities` listener
```

### Task 4.5: Update PROJECT-STATUS.md

Update metrics and add milestone entry.

### Task 4.6: Final Commit

```bash
git add CHANGELOG.md docs/PROJECT-STATUS.md
git commit -m "docs: update CHANGELOG and PROJECT-STATUS for #502, #503, #505"
```

---

## Summary

| Phase | Issue | Tasks | Est. LOC |
|-------|-------|-------|----------|
| 1 | #505 | 2 | ~50 |
| 2 | #503 | 7 | ~300 |
| 3 | #502 | 6 | ~200 |
| 4 | QA | 6 | ~50 |

**Total: 21 tasks across 4 phases**

**Breaking Changes:**
- Requires `migrate:fresh` and full re-import
- `monster_traits` table removed
- `MonsterTrait` model removed

**New Endpoints:**
- `GET /api/v1/lookups/creature-types`

**New Filterable Attributes:**
- `creature_type_slug` on monsters index
